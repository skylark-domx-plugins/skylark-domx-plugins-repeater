/**
 * skylark-ui-repeater - The skylark repeater widget
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylarkui/skylark-ui-repeater/
 * @license MIT
 */
define(["skylark-langx/langx","skylark-utils-dom/browser","skylark-utils-dom/eventer","skylark-utils-dom/noder","skylark-utils-dom/geom","skylark-utils-dom/query","../views","./ViewBase"],function(e,t,i,s,n,l,a,r){var o=r.inherit({klassName:"TableView",options:{list_columnRendered:null,list_columnSizing:!0,list_columnSyncing:!0,list_highlightSortedColumn:!0,list_infiniteScroll:!1,list_noItemsHTML:"no items found",list_selectable:!1,list_sortClearing:!1,list_rowRendered:null,list_frozenColumns:0,list_actions:!1},clearSelectedItems:function(){this.$canvas.find(".repeater-list-check").remove(),this.$canvas.find(".repeater-list table tbody tr.selected").removeClass("selected")},highlightColumn:function(e,t){var i=this.$canvas.find(".repeater-list-wrapper > table tbody");(this.viewOptions.list_highlightSortedColumn||t)&&(i.find("td.sorted").removeClass("sorted"),i.find("tr").each(function(){l(this).find("td:nth-child("+(e+1)+")").filter(function(){return!l(this).parent().hasClass("empty")}).addClass("sorted")}))},getSelectedItems:function(){var e=[];return this.$canvas.find(".repeater-list .repeater-list-wrapper > table tbody tr.selected").each(function(){var t=l(this);e.push({data:t.data("item_data"),element:t})}),e},positionHeadings:function(){var e=this.$element.find(".repeater-list-wrapper"),t=e.offset().left;e.scrollLeft()>0?e.find(".repeater-list-heading").each(function(){var e=l(this),i=e.parents("th:first").offset().left-t+"px";e.addClass("shifted").css("left",i)}):e.find(".repeater-list-heading").each(function(){l(this).removeClass("shifted").css("left","")})},setSelectedItems:function(e,t){var i,s,n,a=this.viewOptions.list_selectable,r=this,o=e;l.isArray(o)||(o=[o]);var d=function(e){s=l(this),(s.data("item_data")||{})[o[i].property]===o[i].value&&c(s,o[i].selected,e)},c=function(e,i,s){var n;void 0===i||i?(t||"multi"===a||r.list_clearSelectedItems(),e.hasClass("selected")||(e.addClass("selected"),(r.viewOptions.list_frozenColumns||"multi"===r.viewOptions.list_selectable)&&((n=r.$element.find(".frozen-column-wrapper tr:nth-child("+(s+1)+")")).addClass("selected"),n.find(".repeater-select-checkbox").addClass("checked")),r.viewOptions.list_actions&&r.$element.find(".actions-column-wrapper tr:nth-child("+(s+1)+")").addClass("selected"),e.find("td:first").prepend('<div class="repeater-list-check"><span class="glyphicon glyphicon-ok"></span></div>'))):(r.viewOptions.list_frozenColumns&&((n=r.$element.find(".frozen-column-wrapper tr:nth-child("+(s+1)+")")).addClass("selected"),n.find(".repeater-select-checkbox").removeClass("checked")),r.viewOptions.list_actions&&r.$element.find(".actions-column-wrapper tr:nth-child("+(s+1)+")").removeClass("selected"),e.find(".repeater-list-check").remove(),e.removeClass("selected"))};for(n=!0===t||"multi"===a?o.length:a&&o.length>0?1:0,i=0;i<n;i++)void 0!==o[i].index?(s=this.$canvas.find(".repeater-list .repeater-list-wrapper > table tbody tr:nth-child("+(o[i].index+1)+")")).length>0&&c(s,o[i].selected,o[i].index):void 0!==o[i].property&&void 0!==o[i].value&&this.$canvas.find(".repeater-list .repeater-list-wrapper > table tbody tr").each(d)},sizeHeadings:function(){this.$element.find(".repeater-list table").find("thead th").each(function(){var e=l(this),t=e.find(".repeater-list-heading");t.css({height:e.outerHeight()}),t.outerWidth(t.data("forced-width")||e.outerWidth())})},setFrozenColumns:function(){var e=this.$canvas.find(".table-frozen"),t=this.$element.find(".repeater-canvas"),i=this.$element.find(".repeater-list .repeater-list-wrapper > table"),s=this.$element.find(".repeater-list"),n=this.viewOptions.list_frozenColumns,a=this;if("multi"===this.viewOptions.list_selectable&&(n+=1,t.addClass("multi-select-enabled")),e.length<1){var r=l('<div class="frozen-column-wrapper"></div>').insertBefore(i),o=i.clone().addClass("table-frozen");o.find("th:not(:lt("+n+"))").remove(),o.find("td:not(:nth-child(n+0):nth-child(-n+"+n+"))").remove();var d=o.clone().removeClass("table-frozen");d.find("tbody").remove();var c=l('<div class="frozen-thead-wrapper"></div>').append(d),h=c.find("th label.checkbox-custom.checkbox-inline");h.attr("id",h.attr("id")+"_cloned"),r.append(o),s.append(c),this.$canvas.addClass("frozen-enabled")}this.list_sizeFrozenColumns(),l(".frozen-thead-wrapper .repeater-list-heading").on("click",function(){var e=l(this).parent("th").index();e+=1,a.$element.find(".repeater-list-wrapper > table thead th:nth-child("+e+") .repeater-list-heading")[0].click()})},positionColumns:function(){var e=this.$element.find(".repeater-canvas"),t=e.scrollTop(),i=e.scrollLeft(),s=this.viewOptions.list_frozenColumns||"multi"===this.viewOptions.list_selectable,n=this.viewOptions.list_actions,l=this.$element.find(".repeater-canvas").outerWidth(),a=this.$element.find(".repeater-list .repeater-list-wrapper > table").outerWidth()-(l-(this.$element.find(".table-actions")?this.$element.find(".table-actions").outerWidth():0))>=i;t>0?e.find(".repeater-list-heading").css("top",t):e.find(".repeater-list-heading").css("top","0"),i>0?(s&&(e.find(".frozen-thead-wrapper").css("left",i),e.find(".frozen-column-wrapper").css("left",i)),n&&a&&(e.find(".actions-thead-wrapper").css("right",-i),e.find(".actions-column-wrapper").css("right",-i))):(s&&(e.find(".frozen-thead-wrapper").css("left","0"),e.find(".frozen-column-wrapper").css("left","0")),n&&(e.find(".actions-thead-wrapper").css("right","0"),e.find(".actions-column-wrapper").css("right","0")))},createItemActions:function(){var e,t,i="",s=this,n=this.$element.find(".repeater-list .repeater-list-wrapper > table"),a=this.$canvas.find(".table-actions");for(e=0,t=this.viewOptions.list_actions.items.length;e<t;e++){var r=this.viewOptions.list_actions.items[e],o=r.html;i+='<li><a href="#" data-action="'+r.name+'" class="action-item"> '+o+"</a></li>"}var d='<div class="btn-group"><button type="button" class="btn btn-xs btn-default dropdown-toggle repeater-actions-button" data-toggle="dropdown" data-flip="auto" aria-expanded="false"><span class="caret"></span></button><ul class="dropdown-menu dropdown-menu-right" role="menu">'+i+"</ul></div>";if(a.length<1){var c=l('<div class="actions-column-wrapper" style="width: '+this.list_actions_width+'px"></div>').insertBefore(n),h=n.clone().addClass("table-actions");if(h.find("th:not(:last-child)").remove(),h.find("tr td:not(:last-child)").remove(),"multi"===this.viewOptions.list_selectable||"action"===this.viewOptions.list_selectable)h.find("thead tr").html('<th><div class="repeater-list-heading">'+d+"</div></th>"),"action"!==this.viewOptions.list_selectable&&h.find("thead .btn").attr("disabled","disabled");else{var p=this.viewOptions.list_actions.label||'<span class="actions-hidden">a</span>';h.find("thead tr").addClass("empty-heading").html("<th>"+p+'<div class="repeater-list-heading">'+p+"</div></th>")}h.find("td").each(function(e){l(this).html(d),l(this).find("a").attr("data-row",e+1)}),c.append(h),this.$canvas.addClass("actions-enabled")}this.list_sizeActionsTable(),this.$element.find(".table-actions tbody .action-item").on("click",function(e){if(!s.isDisabled){var t={actionName:l(this).data("action"),rows:[l(this).data("row")]};s.list_getActionItems(t,e)}}),this.$element.find(".table-actions thead .action-item").on("click",function(e){if(!s.isDisabled){var t={actionName:l(this).data("action"),rows:[]},i=".repeater-list-wrapper > table .selected";"action"===s.viewOptions.list_selectable&&(i=".repeater-list-wrapper > table tr"),s.$element.find(i).each(function(e){t.rows.push(e+1)}),s.list_getActionItems(t,e)}})},getActionItems:function(e,t){for(var i=[],s=l.grep(this.viewOptions.list_actions.items,function(t){return t.name===e.actionName})[0],n=0,a=e.rows.length;n<a;n++){var r=this.$canvas.find(".repeater-list-wrapper > table tbody tr:nth-child("+e.rows[n]+")");i.push({item:r,rowData:r.data("item_data")})}if(1===i.length&&(i=i[0]),s.clickAction){s.clickAction(i,function(){},t)}},sizeActionsTable:function(){var e=this.$element.find(".repeater-list table.table-actions"),t=e.find("thead tr th"),i=this.$element.find(".repeater-list-wrapper > table");t.outerHeight(i.find("thead tr th").outerHeight()),t.find(".repeater-list-heading").outerHeight(t.outerHeight()),e.find("tbody tr td:first-child").each(function(e){l(this).outerHeight(i.find("tbody tr:eq("+e+") td").outerHeight())})},sizeFrozenColumns:function(){var e=this.$element.find(".repeater-list .repeater-list-wrapper > table");this.$element.find(".repeater-list table.table-frozen tr").each(function(t){l(this).height(e.find("tr:eq("+t+")").height())});var t=e.find("td:eq(0)").outerWidth();this.$element.find(".frozen-column-wrapper, .frozen-thead-wrapper").width(t)},frozenOptionsInitialize:function(){var e=this.$element.find(".frozen-column-wrapper .checkbox-inline"),t=this.$element.find(".header-checkbox .checkbox-custom"),i=this.$element.find(".repeater-list table"),s=this;this.$element.find("tr.selectable").on("mouseover mouseleave",function(e){var t=l(this).index();t+=1,"mouseover"===e.type?i.find("tbody tr:nth-child("+t+")").addClass("hovered"):i.find("tbody tr:nth-child("+t+")").removeClass("hovered")}),t.checkbox(),e.checkbox();var n=this.$element.find(".table-frozen tbody .checkbox-inline"),a=this.$element.find(".frozen-thead-wrapper thead .checkbox-inline input");function r(e){s.list_revertingCheckbox=!0,e.checkbox("toggle"),delete s.list_revertingCheckbox}n.on("change",function(e){if(e.preventDefault(),!s.list_revertingCheckbox)if(s.isDisabled)r(l(e.currentTarget));else{var t=l(this).attr("data-row");t=parseInt(t,10)+1,s.$element.find(".repeater-list-wrapper > table tbody tr:nth-child("+t+")").click();var i=s.$element.find(".table-frozen tbody .checkbox-inline.checked").length;0===i?(a.prop("checked",!1),a.prop("indeterminate",!1)):i===n.length?(a.prop("checked",!0),a.prop("indeterminate",!1)):(a.prop("checked",!1),a.prop("indeterminate",!0))}}),a.on("change",function(t){s.list_revertingCheckbox||(s.isDisabled?r(l(t.currentTarget)):l(this).is(":checked")?(s.$element.find(".repeater-list-wrapper > table tbody tr:not(.selected)").click(),s.$element.trigger("selected.fu.repeaterList",e)):(s.$element.find(".repeater-list-wrapper > table tbody tr.selected").click(),s.$element.trigger("deselected.fu.repeaterList",e)))})},cleared:function(){this.viewOptions.list_columnSyncing&&this.list_sizeHeadings()},dataOptions:function(e){return this.list_sortDirection&&(e.sortDirection=this.list_sortDirection),this.list_sortProperty&&(e.sortProperty=this.list_sortProperty),e},enabled:function(e){this.viewOptions.list_actions&&(e.status?(this.$canvas.find(".repeater-actions-button").removeAttr("disabled"),v.call(this)):this.$canvas.find(".repeater-actions-button").attr("disabled","disabled"))},initialize:function(e,t){this.list_sortDirection=null,this.list_sortProperty=null,this.list_specialBrowserClass=m(),this.list_actions_width=void 0!==this.viewOptions.list_actions.width?this.viewOptions.list_actions.width:37,this.list_noItems=!1,t()},resize:function(){u.call(this,this.$element.find(".repeater-list-wrapper > table thead tr")),this.viewOptions.list_actions&&this.list_sizeActionsTable(),(this.viewOptions.list_frozenColumns||"multi"===this.viewOptions.list_selectable)&&this.list_sizeFrozenColumns(),this.viewOptions.list_columnSyncing&&this.list_sizeHeadings()},selected:function(){var e,t=this.viewOptions.list_infiniteScroll;this.list_firstRender=!0,this.$loader.addClass("noHeader"),t&&(e="object"==typeof t?t:{},this.infiniteScrolling(!0,e))},before:function(e){var t,i=e.container.find(".repeater-list"),s=this;return e.data.count>0?this.list_noItems=!1:this.list_noItems=!0,i.length<1&&((i=l('<div class="repeater-list '+this.list_specialBrowserClass+'" data-preserve="shallow"><div class="repeater-list-wrapper" data-infinite="true" data-preserve="shallow"><table aria-readonly="true" class="table" data-preserve="shallow" role="grid"></table></div></div>')).find(".repeater-list-wrapper").on("scroll.fu.repeaterList",function(){s.viewOptions.list_columnSyncing&&s.list_positionHeadings()}),(s.viewOptions.list_frozenColumns||s.viewOptions.list_actions||"multi"===s.viewOptions.list_selectable)&&e.container.on("scroll.fu.repeaterList",function(){s.list_positionColumns()}),e.container.append(i)),e.container.removeClass("actions-enabled actions-enabled multi-select-enabled"),t=i.find("table"),f.call(this,t,e.data),p.call(this,t,e.data),!1},renderItem:function(e){return h.call(this,e.container,e.subset,e.index),!1},after:function(){var e;return!this.viewOptions.list_frozenColumns&&"multi"!==this.viewOptions.list_selectable||this.list_noItems||this.list_setFrozenColumns(),this.viewOptions.list_actions&&!this.list_noItems&&(this.list_createItemActions(),this.list_sizeActionsTable()),!this.viewOptions.list_frozenColumns&&!this.viewOptions.list_actions&&"multi"!==this.viewOptions.list_selectable||this.list_noItems||(this.list_positionColumns(),this.list_frozenOptionsInitialize()),this.viewOptions.list_columnSyncing&&(this.list_sizeHeadings(),this.list_positionHeadings()),(e=this.$canvas.find(".repeater-list-wrapper > table .repeater-list-heading.sorted")).length>0&&this.list_highlightColumn(e.data("fu_item_index")),!1}}),d=function(e,t,i,s,n){var a=s[n].className,r=t[i][s[n].property],o=l("<td></td>"),d=s[n]._auto_width,c=s[n].property;if(!1!==this.viewOptions.list_actions&&"@_ACTIONS_@"===c&&(r='<div class="repeater-list-actions-placeholder" style="width: '+this.list_actions_width+'px"></div>'),r=void 0!==r?r:"",o.addClass(void 0!==a?a:"").append(r),void 0!==d&&o.outerWidth(d),e.append(o),"multi"===this.viewOptions.list_selectable&&"@_CHECKBOX_@"===s[n].property){var h='<label data-row="'+i+'" class="checkbox-custom checkbox-inline body-checkbox repeater-select-checkbox"><input class="sr-only" type="checkbox"></label>';o.html(h)}return o},c=function(e,t,i){var s,n,a,r,o,d="glyphicon-chevron-down",c="glyphicon-chevron-up",h=l('<div class="repeater-list-heading"><span class="glyphicon rlc"></span></div>'),p='<div class="repeater-list-heading header-checkbox"><label id="'+((this.$element.attr("id")+"_"||"")+"checkall")+'" class="checkbox-custom checkbox-inline"><input class="sr-only" type="checkbox" value=""><span class="checkbox-label">&nbsp;</span></label></div>',f=l("<th></th>"),u=this;if(h.data("fu_item_index",i),h.prepend(t[i].label),f.html(h.html()).find("[id]").removeAttr("id"),"@_CHECKBOX_@"!==t[i].property?f.append(h):f.append(p),s=f.add(h),r=h.find(".glyphicon.rlc:first"),o=r.add(f.find(".glyphicon.rlc:first")),this.viewOptions.list_actions&&"@_ACTIONS_@"===t[i].property){var m=this.list_actions_width;f.css("width",m),h.css("width",m)}void 0!==(n=t[i].className)&&s.addClass(n),(a=t[i].sortable)&&(s.addClass("sortable"),h.on("click.fu.repeaterList",function(){u.isDisabled||(u.list_sortProperty="string"==typeof a?a:t[i].property,h.hasClass("sorted")?r.hasClass(c)?(o.removeClass(c).addClass(d),u.list_sortDirection="desc"):u.viewOptions.list_sortClearing?(s.removeClass("sorted"),o.removeClass(d),u.list_sortDirection=null,u.list_sortProperty=null):(o.removeClass(d).addClass(c),u.list_sortDirection="asc"):(e.find("th, .repeater-list-heading").removeClass("sorted"),o.removeClass(d).addClass(c),u.list_sortDirection="asc",s.addClass("sorted")),u.render({clearInfinite:!0,pageIncrement:null}))})),"asc"!==t[i].sortDirection&&"desc"!==t[i].sortDirection||(e.find("th, .repeater-list-heading").removeClass("sorted"),s.addClass("sortable sorted"),"asc"===t[i].sortDirection?(o.addClass(c),this.list_sortDirection="asc"):(o.addClass(d),this.list_sortDirection="desc"),this.list_sortProperty="string"==typeof a?a:t[i].property),e.append(f)},h=function(e,t,i){var s=l("<tr></tr>");if(this.viewOptions.list_selectable&&(s.data("item_data",t[i]),"action"!==this.viewOptions.list_selectable)){s.addClass("selectable"),s.attr("tabindex",0);var n=this;s.on("click.fu.repeaterList",function(){(function(e){var t="multi"===e.viewOptions.list_selectable,i=e.viewOptions.list_actions,s=e.$element;if(!e.isDisabled){var n=l(this),a=l(this).index()+1,r=s.find(".frozen-column-wrapper tr:nth-child("+a+")"),o=s.find(".actions-column-wrapper tr:nth-child("+a+")"),d=s.find(".frozen-column-wrapper tr:nth-child("+a+") .checkbox-inline");n.is(".selected")?(n.removeClass("selected"),t?(d.click(),r.removeClass("selected"),i&&o.removeClass("selected")):n.find(".repeater-list-check").remove(),s.trigger("deselected.fu.repeaterList",n)):(t?(d.click(),n.addClass("selected"),r.addClass("selected"),i&&o.addClass("selected")):(e.$canvas.find(".repeater-list-check").remove(),e.$canvas.find(".repeater-list tbody tr.selected").each(function(){l(this).removeClass("selected"),s.trigger("deselected.fu.repeaterList",l(this))}),n.find("td:first").prepend('<div class="repeater-list-check"><span class="glyphicon glyphicon-ok"></span></div>'),n.addClass("selected"),r.addClass("selected")),s.trigger("selected.fu.repeaterList",n)),v.call(e)}}).call(this,n)}),s.keyup(function(e){13===e.keyCode&&s.trigger("click.fu.repeaterList")})}this.viewOptions.list_actions&&!this.viewOptions.list_selectable&&s.data("item_data",t[i]);for(var a=[],r=0,o=this.list_columns.length;r<o;r++)a.push(d.call(this,s,t,i,this.list_columns,r));if(e.append(s),this.viewOptions.list_columnRendered)for(var c=0,h=a.length;c<h;c++)"@_CHECKBOX_@"!==this.list_columns[c].property&&"@_ACTIONS_@"!==this.list_columns[c].property&&this.viewOptions.list_columnRendered({container:s,columnAttr:this.list_columns[c].property,item:a[c],rowData:t[i]},function(){});this.viewOptions.list_rowRendered&&this.viewOptions.list_rowRendered({container:e,item:s,rowData:t[i]},function(){})},p=function(e,t){var i,s=e.find("tbody");s.length<1&&(s=l('<tbody data-container="true"></tbody>'),e.append(s)),"string"==typeof t.error&&t.error.length>0?((i=l('<tr class="empty text-danger"><td colspan="'+this.list_columns.length+'"></td></tr>')).find("td").append(t.error),s.append(i)):t.items&&t.items.length<1&&((i=l('<tr class="empty"><td colspan="'+this.list_columns.length+'"></td></tr>')).find("td").append(this.viewOptions.list_noItemsHTML),s.append(i))},f=function(e,t){var i,s,n,a=t.columns||[],r=e.find("thead");if(this.list_firstRender||function(e,t){if(!t)return!1;if(!e||t.length!==e.length)return!0;for(var i=0,s=t.length;i<s;i++){if(!e[i])return!0;for(var n in t[i])if(t[i].hasOwnProperty(n)&&e[i][n]!==t[i][n])return!0}return!1}(this.list_columns,a)||0===r.length){if(r.remove(),"multi"===this.viewOptions.list_selectable&&!this.list_noItems){a.splice(0,0,{label:"c",property:"@_CHECKBOX_@",sortable:!1})}if(this.list_columns=a,this.list_firstRender=!1,this.$loader.removeClass("noHeader"),this.viewOptions.list_actions){var o={label:this.viewOptions.list_actions.label||'<span class="actions-hidden">a</span>',property:"@_ACTIONS_@",sortable:!1,width:this.list_actions_width};a.push(o)}for(n=(r=l('<thead data-preserve="deep"><tr></tr></thead>')).find("tr"),i=0,s=a.length;i<s;i++)c.call(this,n,a,i);if(e.prepend(r),"multi"===this.viewOptions.list_selectable&&!this.list_noItems){var d=this.$element.find(".repeater-list-wrapper .header-checkbox").outerWidth();l.grep(a,function(e){return"@_CHECKBOX_@"===e.property})[0].width=d}u.call(this,n)}},u=function(e){var t,i,s,n,a=[],r=this;if(this.viewOptions.list_columnSizing&&(t=0,n=0,e.find("th").each(function(){var e,i=l(this);if(void 0!==r.list_columns[t].width)e=r.list_columns[t].width,i.outerWidth(e),n+=i.outerWidth(),r.list_columns[t]._auto_width=e;else{var s=i.find(".repeater-list-heading").outerWidth();a.push({col:i,index:t,minWidth:s})}t++}),(i=a.length)>0)){var o=this.$canvas.find(".repeater-list-wrapper").outerWidth();for(s=Math.floor((o-n)/i),t=0;t<i;t++)a[t].minWidth>s&&(s=a[t].minWidth),a[t].col.outerWidth(s),this.list_columns[a[t].index]._auto_width=s}},m=function(){var e=window.navigator.userAgent,t=e.indexOf("MSIE "),i=e.indexOf("Firefox");return t>0?"ie-"+parseInt(e.substring(t+5,e.indexOf(".",t)),10):i>0?"firefox":""},v=function(){var e=".repeater-list-wrapper > table .selected",t=this.$element.find(".table-actions");"action"===this.viewOptions.list_selectable&&(e=".repeater-list-wrapper > table tr"),this.$canvas.find(e).length>0?t.find("thead .btn").removeAttr("disabled"):t.find("thead .btn").attr("disabled","disabled")};return a.table={name:"table",ctor:o}});
//# sourceMappingURL=../sourcemaps/views/table.js.map
